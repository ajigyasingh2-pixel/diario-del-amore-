<!DOCTYPE html>

<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>Diario di Bea ‚Äî Diario Segreto</title>
<style>
  :root{
    --gold:#d4af37;
    --deep:#3a0608;
    --velvet:#5b0b12;
    --paper:#fff6ec;
    --ink:#4b1e27;
  }
  html,body{height:100%;margin:0;font-family: Georgia, "Times New Roman", serif;background: radial-gradient(circle at 10% 10%, rgba(212,175,55,0.06), transparent 10%),
    linear-gradient(180deg,#3a0608 0%, #5b0b12 45%, #2a0506 100%); color:var(--ink); -webkit-font-smoothing:antialiased;}
  /* subtle velvet texture */
  body::after{
    content:""; position:fixed; inset:0; pointer-events:none;
    background-image:
      radial-gradient(rgba(255,255,255,0.02) 1px, transparent 1px);
    background-size:40px 40px; opacity:0.08;
  }

/* center book */
#bookWrap{ width:94vw; max-width:760px; height:86vh; max-height:720px; margin:4vh auto; display:flex; align-items:center; justify-content:center; position:relative;}
#book{
width:100%; height:100%; max-height:720px; background:linear-gradient(180deg,var(--paper),#fff0e0 60%); border-radius:18px;
box-shadow: 0 20px 80px rgba(0,0,0,0.6), inset 0 4px 10px rgba(212,175,55,0.07);
border:8px solid rgba(212,175,55,0.9); position:relative; overflow:hidden; perspective:2000px;
}

/* top decorative band with title */
#coverFace{
position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
background:linear-gradient(135deg, rgba(91,11,18,0.95), rgba(58,4,8,0.95));
color:var(--gold); font-weight:700; font-size:28px; letter-spacing:1px; text-align:center; cursor:pointer;
transition: transform .8s cubic-bezier(.2,.9,.2,1), opacity 0.6s ease;
}
#coverFace .sub{font-size:14px; color:rgba(255,238,210,0.9); margin-top:8px; font-weight:400;}

/* pages stack */
.page {
position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
padding:28px; box-sizing:border-box; transform-origin:left center; transition: transform .9s cubic-bezier(.2,.9,.2,1), opacity .6s ease;
}
.hidden{ display:none !important; opacity:0; transform:translateX(10%) scale(.98); }

.pageInner{
width:95%; max-width:640px; height:85%; background:linear-gradient(180deg,#fffaf2,#fff3e6);
border-radius:12px; border:2px solid rgba(212,175,55,0.12); box-shadow: 0 8px 30px rgba(0,0,0,0.25);
padding:28px; position:relative; overflow:hidden;
}

/* phrase bubble (paper-like) */
.bubble {
display:block; background: linear-gradient(180deg,#fffdf8,#fff6ee);
border-radius:14px; padding:18px 22px; box-shadow:0 6px 20px rgba(0,0,0,0.25);
border:2px solid rgba(212,175,55,0.25); color:var(--deep); font-size:20px; max-width:86%;
line-height:1.4; font-family: "Georgia", serif;
}

/* bottom controls */
.controls { position:absolute; bottom:18px; left:50%; transform:translateX(-50%); display:flex; gap:12px; z-index:30; }
.btn {
background:var(--gold); border:none; padding:10px 16px; border-radius:10px; color:var(--deep); font-weight:700; cursor:pointer;
box-shadow: 0 6px 18px rgba(0,0,0,0.25); font-family: Georgia, serif;
}
.btn:active{ transform:translateY(2px); }

/* canvas for interactions */
#interactCanvas{ position:absolute; left:50%; transform:translateX(-50%); top:12%; width:86%; height:64%; max-height:520px; border-radius:10px; }
/* scratch canvas overlay sizes will match the interact canvas */

/* decorative pen (top-left) */
.pen{ position:absolute; top:12px; left:18px; z-index:40; color:var(--gold); font-size:20px; opacity:0.95; }

/* final page styling */
#finalPage .big {
font-size:34px; color:var(--deep); font-weight:800; letter-spacing:0.6px;
}

/* small responsive tweaks */
@media(max-width:600px){
#bookWrap{ height:92vh; margin-top:2vh; }
.bubble{ font-size:18px; padding:14px; }
} </style>

</head>
<body>
  <div id="bookWrap">
    <div id="book" role="application" aria-label="Diario di Bea">
      <!-- COVER -->
      <div id="coverFace" class="page">
        <div style="text-align:center;">
          <div style="font-size:40px">üìñ</div>
          <div style="font-family:Georgia,serif;font-weight:900;font-size:30px">Diario di Bea</div>
          <div class="sub">Tocca per aprire il diario e scoprire i miei pensieri</div>
        </div>
      </div>

```
  <!-- PAGE 1: hearts -->
  <div id="page1" class="page hidden" aria-hidden="true">
    <div class="pageInner">
      <div style="position:absolute;left:22px;top:18px;" class="pen">‚úíÔ∏è</div>
      <div style="margin-top:6px;font-family:Georgia,serif;color:var(--deep);font-size:20px;text-align:center;">
        <div style="margin-bottom:10px;">Pagina 1 ‚Äî Cuori d'Inchiostro</div>
        <div class="bubble" id="p1bubble">Clicca o tocca i cuori che appaiono. Collezionali tutti.</div>
      </div>
      <canvas id="interactCanvas"></canvas>
      <div class="controls" style="position:absolute;right:18px;bottom:18px;left:auto;">
        <button class="btn" id="p1Next" style="display:none">Prosegui ‚ûú</button>
      </div>
    </div>
  </div>

  <!-- PAGE 2: stars -->
  <div id="page2" class="page hidden" aria-hidden="true">
    <div class="pageInner">
      <div style="position:absolute;left:22px;top:18px;" class="pen">‚úíÔ∏è</div>
      <div style="margin-top:6px;font-family:Georgia,serif;color:var(--deep);font-size:20px;text-align:center;">
        <div style="margin-bottom:10px;">Pagina 2 ‚Äî Stelle tra le parole</div>
        <div class="bubble" id="p2bubble">Tocca ogni stella dorata per farla brillare.</div>
      </div>
      <canvas id="starCanvas" style="width:100%;height:62%;display:block;margin-top:20px;"></canvas>
      <div class="controls" style="position:absolute;right:18px;bottom:18px;left:auto;">
        <button class="btn" id="p2Next" style="display:none">Prosegui ‚ûú</button>
        <button class="btn" id="p2Back" style="display:inline-block;margin-left:8px">‚óÄ Indietro</button>
      </div>
    </div>
  </div>

  <!-- PAGE 3: scratch -->
  <div id="page3" class="page hidden" aria-hidden="true">
    <div class="pageInner">
      <div style="position:absolute;left:22px;top:18px;" class="pen">‚úíÔ∏è</div>
      <div style="margin-top:6px;font-family:Georgia,serif;color:var(--deep);font-size:20px;text-align:center;">
        <div style="margin-bottom:10px;">Pagina 3 ‚Äî Pagina Nascosta</div>
        <div class="bubble" id="p3bubble">Sfrega con il dito o il mouse per rivelare il segreto</div>
      </div>
      <canvas id="scratchCanvas" style="width:100%;height:62%;display:block;margin-top:20px;border-radius:8px;"></canvas>
      <div class="controls" style="position:absolute;right:18px;bottom:18px;left:auto;">
        <button class="btn" id="p3Next" style="display:none">Chiudi il diario üíû</button>
        <button class="btn" id="p3Back" style="display:inline-block;margin-left:8px">‚óÄ Indietro</button>
      </div>
    </div>
  </div>

  <!-- FINAL PAGE -->
  <div id="finalPage" class="page hidden" aria-hidden="true">
    <div class="pageInner" style="display:flex;flex-direction:column;align-items:center;justify-content:center;">
      <div class="big" id="finalPhrase" style="text-align:center;color:var(--deep);"> </div>
      <div style="margin-top:20px;"><button class="btn" id="restartBtn">Ricomincia</button></div>
    </div>
  </div>

</div>
```

  </div>

  <!-- audio (will be played after first tap - allowed by browsers) -->

  <audio id="bgMusic" loop preload="auto">
    <source src="https://cdn.pixabay.com/download/audio/2022/10/18/audio_b40399a7a1.mp3?filename=romantic-piano-loop-12285.mp3" type="audio/mpeg">
  </audio>
  <audio id="popSnd" preload="auto">
    <source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_1ce6a8f0a1.mp3?filename=pop-1-5852.mp3" type="audio/mpeg">
  </audio>

<script>
/* ==========================
   Utilities & responsive canvas sizing
   ========================== */
function fitCanvasToContainer(canvasElem, containerElem){
  const rect = containerElem.getBoundingClientRect();
  // set canvas pixel size to device pixels for sharpness
  const dpr = window.devicePixelRatio || 1;
  const width = Math.max(300, Math.floor(rect.width * 0.96));
  const height = Math.max(180, Math.floor(rect.height * 0.62));
  canvasElem.width = Math.floor(width * dpr);
  canvasElem.height = Math.floor(height * dpr);
  canvasElem.style.width = Math.floor(width) + "px";
  canvasElem.style.height = Math.floor(height) + "px";
  const ctx = canvasElem.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return ctx;
}

/* ==========================
   Page management
   ========================== */
const pages = ['cover','page1','page2','page3','finalPage'];
let currentPage = 0;
const coverEl = document.getElementById('coverFace');

function showPage(index){
  pages.forEach((id,i)=>{
    const el = document.getElementById(id);
    if(i===index){
      el.classList.remove('hidden');
      el.setAttribute('aria-hidden','false');
    } else {
      el.classList.add('hidden');
      el.setAttribute('aria-hidden','true');
    }
  });
  currentPage = index;
  // initialize page-specific logic
  if(index===1) initPage1();
  if(index===2) initPage2();
  if(index===3) initPage3();
  if(index===4) initFinal();
}

/* ==========================
   Audio start on open
   ========================== */
const bgMusic = document.getElementById('bgMusic');
coverEl.addEventListener('click', () => {
  // Start music after user interaction (allowed by mobile browsers)
  bgMusic.play().catch(()=>{ /* ignore */ });
  showPage(1);
});

/* ==========================
   PAGE 1 ‚Äî Hearts collection (canvas-based)
   ========================== */
const interactCanvas = document.getElementById('interactCanvas');
const interactContainer = document.querySelector('#page1 .pageInner');
let ictx, hearts=[], heartCollected=0, heartSpawnTimer=null, animating=false;
function initPage1(){
  // prepare canvas
  ictx = fitCanvasToContainer(interactCanvas, interactContainer);
  hearts = [];
  heartCollected = 0;
  document.getElementById('p1Next').style.display = 'none';
  // spawn hearts until target reached
  const target = 7;
  clearInterval(heartSpawnTimer);
  heartSpawnTimer = setInterval(()=> {
    if(hearts.length < 10 && heartCollected < target) spawnHeart();
  }, 700);
  // start render loop
  if(!animating){ animating=true; requestAnimationFrame(interactLoop); }
  // click/touch handler
  function onHit(e){
    const rect = interactCanvas.getBoundingClientRect();
    let x = (e.clientX || e.touches && e.touches[0].clientX) - rect.left;
    let y = (e.clientY || e.touches && e.touches[0].clientY) - rect.top;
    // check hearts (iterate backwards)
    for(let i=hearts.length-1;i>=0;i--){
      const h = hearts[i];
      const dx = x - h.x, dy = y - h.y;
      if(Math.hypot(dx,dy) < h.size){
        // collect
        hearts.splice(i,1);
        heartCollected++;
        playPop();
        // small particle burst
        for(let p=0;p<12;p++) {
          particles.push({x:h.x, y:h.y, vx:(Math.random()-0.5)*2.5, vy:(Math.random()-0.9)*-2.5, life:40, size:2+Math.random()*3});
        }
        if(heartCollected >= target){
          clearInterval(heartSpawnTimer);
          // reveal phrase with pen effect on bubble
          const bubble = document.getElementById('p1bubble');
          bubble.textContent = '';
          typeWriter("Ogni cuore che disegno √® per te, Bea ‚ù§Ô∏è", bubble, ()=> {
            document.getElementById('p1Next').style.display='inline-block';
          });
        }
        break;
      }
    }
  }
  interactCanvas.removeEventListener('click', interactCanvas._handler);
  interactCanvas._handler = onHit;
  interactCanvas.addEventListener('click', onHit);
  interactCanvas.addEventListener('touchstart', onHit);
}

function spawnHeart(){
  const r = 16 + Math.random()*8;
  const w = interactCanvas.width / (window.devicePixelRatio || 1);
  const h = interactCanvas.height / (window.devicePixelRatio || 1);
  const x = Math.random()*(w - 2*r) + r;
  const y = h - 10;
  const speed = 0.6 + Math.random()*1.1;
  hearts.push({x,y,size:r,speed});
}

/* drawing & particles shared for page1 */
let particles = [];
function interactLoop(){
  // clear
  ictx.clearRect(0,0,interactCanvas.width,interactCanvas.height);
  const w = interactCanvas.width/(window.devicePixelRatio||1);
  const h = interactCanvas.height/(window.devicePixelRatio||1);

  // update and draw hearts
  for(let i=hearts.length-1;i>=0;i--){
    const hobj = hearts[i];
    hobj.y -= hobj.speed;
    drawHeart(ictx,hobj.x,hobj.y,hobj.size,'#ff5366');
    if(hobj.y + hobj.size < -20) hearts.splice(i,1);
  }

  // particles
  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.x += p.vx; p.y += p.vy; p.vy += 0.05; p.life--;
    ictx.fillStyle = `rgba(255,100,150,${Math.max(0,p.life/40)})`;
    ictx.beginPath(); ictx.arc(p.x,p.y,p.size,0,Math.PI*2); ictx.fill();
    if(p.life<=0) particles.splice(i,1);
  }

  // draw subtle overlay text if needed
  requestAnimationFrame(interactLoop);
}

/* heart drawing helper */
function drawHeart(ctx,x,y,size,color){
  ctx.save();
  ctx.fillStyle = color;
  ctx.beginPath();
  // draw a simple heart via bezier
  const s = size;
  ctx.moveTo(x, y - s/2);
  ctx.bezierCurveTo(x + s, y - s*1.3, x + s*1.5, y + s/3, x, y + s);
  ctx.bezierCurveTo(x - s*1.5, y + s/3, x - s, y - s*1.3, x, y - s/2);
  ctx.fill();
  ctx.restore();
}
function playPop(){ try{ document.getElementById('popSnd').currentTime=0; document.getElementById('popSnd').play(); }catch(e){} }

/* PAGE 1 next button */
document.getElementById('p1Next').addEventListener('click', ()=> showPage(2));

/* ==========================
   PAGE 2 ‚Äî Stars (canvas)
   ========================== */
const starCanvas = document.getElementById('starCanvas');
let sctx, stars=[];
function initPage2(){
  sctx = fitCanvasToContainer(starCanvas, document.querySelector('#page2 .pageInner'));
  stars = [];
  document.getElementById('p2Next').style.display='none';
  // create 6 nice positions
  const w = starCanvas.width/(window.devicePixelRatio||1);
  const h = starCanvas.height/(window.devicePixelRatio||1);
  for(let i=0;i<6;i++){
    stars.push({x:40 + Math.random()*(w-80), y:30 + Math.random()*(h-60), lit:false, r:8});
  }
  drawStars();

  function starClick(e){
    const rect = starCanvas.getBoundingClientRect();
    let x = (e.clientX || e.touches && e.touches[0].clientX) - rect.left;
    let y = (e.clientY || e.touches && e.touches[0].clientY) - rect.top;
    for(let s of stars){
      if(Math.hypot(x-s.x,y-s.y) < 18) s.lit = true;
    }
    drawStars();
    if(stars.every(s=>s.lit)){
      const bubble = document.getElementById('p2bubble');
      bubble.textContent = ''; typeWriter("Sei la luce che illumina ogni pagina del mio cuore ‚ú®", bubble, ()=> {
        document.getElementById('p2Next').style.display='inline-block';
      });
      starCanvas.removeEventListener('click',starClick);
      starCanvas.removeEventListener('touchstart',starClick);
    }
  }
  starCanvas.removeEventListener('click', starCanvas._handler);
  starCanvas._handler = starClick;
  starCanvas.addEventListener('click', starClick);
  starCanvas.addEventListener('touchstart', starClick);
}
function drawStars(){
  const w = starCanvas.width/(window.devicePixelRatio||1);
  const h = starCanvas.height/(window.devicePixelRatio||1);
  sctx.clearRect(0,0,w,h);
  for(let s of stars){
    sctx.beginPath();
    sctx.arc(s.x,s.y, s.r, 0, Math.PI*2);
    sctx.fillStyle = s.lit ? '#ffd662' : 'rgba(255,215,0,0.25)';
    sctx.fill();
    if(s.lit){
      // glow
      sctx.beginPath(); sctx.arc(s.x,s.y, s.r+8, 0, Math.PI*2);
      sctx.fillStyle = 'rgba(255,215,0,0.08)'; sctx.fill();
    }
  }
}
document.getElementById('p2Next').addEventListener('click', ()=> showPage(3));
document.getElementById('p2Back').addEventListener('click', ()=> showPage(1));

/* ==========================
   PAGE 3 ‚Äî Scratch reveal
   ========================== */
const scratchCanvas = document.getElementById('scratchCanvas');
let scrCtx, scratchChecking=false;
function initPage3(){
  scrCtx = fitCanvasToContainer(scratchCanvas, document.querySelector('#page3 .pageInner'));
  // draw hidden artwork (a heart and phrase) underneath
  const w = scratchCanvas.width/(window.devicePixelRatio||1);
  const h = scratchCanvas.height/(window.devicePixelRatio||1);
  // draw the message below
  // We'll draw the image on a separate offscreen canvas then overlay mask
  const off = document.createElement('canvas');
  off.width = scratchCanvas.width; off.height = scratchCanvas.height;
  const offCtx = off.getContext('2d'); offCtx.setTransform(window.devicePixelRatio||1,0,0,window.devicePixelRatio||1,0,0);
  offCtx.fillStyle = '#fff7f0';
  offCtx.fillRect(0,0,w,h);
  // nice heart
  offCtx.fillStyle = '#ff4a6b';
  offCtx.beginPath();
  offCtx.moveTo(w/2, h/2 - 20);
  offCtx.bezierCurveTo(w/2 + 40, h/2 - 80, w/2 + 90, h/2 + 10, w/2, h/2 + 70);
  offCtx.bezierCurveTo(w/2 - 90, h/2 +10, w/2 - 40, h/2 - 80, w/2, h/2 - 20);
  offCtx.fill();
  // phrase
  offCtx.fillStyle = '#4b1e27'; offCtx.font = '18px Georgia';
  offCtx.textAlign='center'; offCtx.fillText('Sotto ogni segreto, c‚Äô√® il mio amore per te ‚ù§Ô∏è', w/2, h - 30);

  // put the image onto visible canvas as background
  // We'll draw mask above
  scrCtx.clearRect(0,0,scratchCanvas.width,scratchCanvas.height);
  // draw the "hidden" image to a background layer via CSS (we'll keep it in memory)
  scratchCanvas.dataset.hidden = off.toDataURL();

  // Create an opaque mask over the canvas
  scrCtx.fillStyle = '#9b9b9b';
  scrCtx.fillRect(0,0,w,h);
  scrCtx.globalCompositeOperation = 'destination-out';

  let isDrawing=false;
  function pointerDown(e){
    isDrawing=true; pointerMove(e);
  }
  function pointerUp(){ isDrawing=false; checkScratchReveal(); }
  function pointerMove(e){
    if(!isDrawing) return;
    const rect = scratchCanvas.getBoundingClientRect();
    const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
    const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
    const x = clientX - rect.left, y = clientY - rect.top;
    scrCtx.beginPath(); scrCtx.arc(x, y, 24, 0, Math.PI*2); scrCtx.fill();
  }
  scratchCanvas.addEventListener('mousedown', pointerDown);
  scratchCanvas.addEventListener('mousemove', pointerMove);
  window.addEventListener('mouseup', pointerUp);
  scratchCanvas.addEventListener('touchstart', pointerDown, {passive:false});
  scratchCanvas.addEventListener('touchmove', pointerMove, {passive:false});
  scratchCanvas.addEventListener('touchend', pointerUp);

  // overlay the hidden image below via background using CSS trick
  scratchCanvas.style.backgroundImage = `url(${scratchCanvas.dataset.hidden})`;
  scratchCanvas.style.backgroundSize = 'cover';
  // check reveal periodically
  if(!scratchChecking){
    scratchChecking=true;
    const checkInterval = setInterval(()=>{
      // compute pixels cleared
      try{
        const pixels = scrCtx.getImageData(0,0,scratchCanvas.width,scratchCanvas.height).data;
        let cleared=0;
        for(let i=3;i<pixels.length;i+=4){
          if(pixels[i]===0) cleared++;
        }
        const total = scratchCanvas.width * scratchCanvas.height;
        if(cleared/total > 0.35){ // 35% revealed
          clearInterval(checkInterval);
          scratchChecking=false;
          // reveal completion
          const page = document.getElementById('page3');
          page.querySelector('.bubble').textContent='';
          typeWriter("Sotto ogni segreto, c‚Äô√® il mio amore per te ‚ù§Ô∏è", page.querySelector('.bubble'), ()=> {
            document.getElementById('p3Next').style.display='inline-block';
          });
        }
      }catch(e){
        // some browsers block getImageData for cross-origin, but our canvas is local ‚Äî ignore errors defensively
      }
    },700);
  }
}
document.getElementById('p3Next').addEventListener('click', ()=> showPage(4));
document.getElementById('p3Back').addEventListener('click', ()=> showPage(2));

/* ==========================
   FINAL page
   ========================== */
function initFinal(){
  // final animation and phrase
  const el = document.getElementById('finalPhrase');
  el.textContent = '';
  // small particle fall
  for(let i=0;i<40;i++){
    const pet = document.createElement('div');
    pet.className='petal';
    pet.style.left = (10 + Math.random()*80) + 'vw';
    pet.style.animationDuration = (4 + Math.random()*6) + 's';
    pet.style.background = 'radial-gradient(circle at center, #ffd6e0 40%, transparent 90%)';
    document.body.appendChild(pet);
    setTimeout(()=>pet.remove(), 11000);
  }
  typeWriter("Bea, tu sei la mia storia pi√π bella üìñüíû", el);
}

/* ----------------------------
   small utilities
   ---------------------------- */
function typeWriter(text, element, cb){
  element.textContent = '';
  let i=0;
  (function step(){
    if(i<text.length){ element.textContent += text[i++]; setTimeout(step, 45); }
    else if(cb) cb();
  })();
}

/* ----------------------------
   event wiring for nav & restart
   ---------------------------- */
document.getElementById('p2Back').addEventListener('click', ()=> showPage(1));
document.getElementById('p3Back').addEventListener('click', ()=> showPage(2));
document.getElementById('restartBtn').addEventListener('click', ()=> location.reload());

/* ensure canvases adapt on resize */
window.addEventListener('resize', ()=>{
  if(currentPage===1) fitCanvasToContainer(interactCanvas, interactContainer);
  if(currentPage===2) fitCanvasToContainer(starCanvas, document.querySelector('#page2 .pageInner'));
  if(currentPage===3) fitCanvasToContainer(scratchCanvas, document.querySelector('#page3 .pageInner'));
});

/* init: show cover by default (already visible) */
showPage(0);
</script>

</body>
</html>
